<!doctype html>
<html lang="en" class="h-full">
    <head>
        <title>MayorTech Limited</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="How I got Xonsh to auto-complete using my SSH config"
        />
        <link href="/styles.css" rel="stylesheet" />
        <script
            src="https://kit.fontawesome.com/0ebfed0803.js"
            crossorigin="anonymous"
            defer
            async
        ></script>
        <script
            defer
            src="https://api.pirsch.io/pa.js"
            id="pianjs"
            data-code="EzgOWgXDZppcr8suk1FApdXVGO5KY2Cg"
        ></script>
        
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/nord.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

    </head>

    <body class="bg-mt-darkest-blue text-slate-50 flex flex-col gap-8 h-full">
        <div class="border-b-2 border-mt-dark-blue py-4 px-4">
            <header
                class="flex flex-col sm:flex-row items-center justify-between"
            >
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <a
                        class="flex flex-row items-center gap-2 font-bold text-2xl"
                        href="/"
                    >
                        <img
                            src="/img/logo.png"
                            alt="The MayorTech limited logo; a pixel art cartoon image of William Mayor."
                            height="56"
                            class="h-14"
                        />
                        MayorTech Limited
                    </a>
                    <a
                        href="#main"
                        class="translate-y-[-1000px] focus:translate-y-0"
                    >
                        Skip to main content
                    </a>
                </div>
                <nav class="">
                    <ul class="flex flex-row flex-wrap items-center gap-4">
                        <li class="">
                            <a
                                class="hover:text-mt-red "
                                href="/"
                            >
                                Home
                            </a>
                        </li>
                        <li class="">
                            <a
                                class="hover:text-mt-red "
                                href="/work/"
                            >
                                Work
                            </a>
                        </li>
                        <li class="">
                            <a
                                class="hover:text-mt-red "
                                href="/projects/"
                            >
                                Projects
                            </a>
                        </li>
                        <li class="">
                            <a
                                class="hover:text-mt-red text-mt-red"
                                href="/posts/"
                            >
                                Blog
                            </a>
                        </li>
                        <li class="">
                            <a
                                class="hover:text-mt-red"
                                href="/cv/"
                            >
                                CV
                            </a>
                        </li>
                        <li class="">
                            <a
                                class="hover:text-mt-red "
                                href="/contact/"
                            >
                                Contact
                            </a>
                        </li>
                    </ul>
                </nav>
            </header>
        </div>
        <main id="main" class="grow px-4 sm:px-8">
    <div class="max-w-3xl mx-auto bg-mt-gray rounded-xl p-4 sm:p-8">
        <div class="text-mt-darkest-blue text-sm mb-8">2025-08-26</div>
        <div class="text-mt-darkest-blue prose prose-xl"><h1>Xonsh SSH auto-complete</h1>
<p>I recently tried switching over to the <a href="https://xon.sh/index.html">xonsh shell</a>. I&rsquo;m
normally a very happy bash user, but a few years ago MacOS started shipping with zsh as
the default shell and that started me on a journey of new shell discovery. Don&rsquo;t get me
wrong, zsh is pretty good, and I&rsquo;m a big fan of <a href="https://ohmyz.sh/">oh-my-zsh</a> and all
of the plugins and themes it comes with. But now that I&rsquo;m not always using bash, I&rsquo;m
free to take a look around and explore the other options.</p>
<p>xonsh appeals to me because it&rsquo;s a python-based shell. That means the code that runs the
shell is written in Python, so it&rsquo;s easy for me to take a look if I want. It also means
that interacting with the shell means writing Python code, which I&rsquo;m very happy to do.
Plugins and extensions are all in Python too.</p>
<p>When I first installed it I noticed something that was missing. SSH host autocomplete. I
start up the shell, type <code>ssh &lt;tab&gt;</code> and nothing, it doesn&rsquo;t present me with a list of
SSH command options, or hostnames, nothing. I&rsquo;m used to hostname autocompletion from
zsh, it&rsquo;s very handy.</p>
<p>I couldn&rsquo;t find anything in the docs about hostname autocomplete, so I don&rsquo;t think it&rsquo;s
something supported out of the box. I did find lots about how to make your own
autocomplete plugin (or a xontrib in xonsh parlance).</p>
<p>This felt like an opportunity too good to miss. So I built one, here it is:</p>
<pre><code class="language-python">from pathlib import Path

from xonsh.built_ins import XonshSession
from xonsh.completers.tools import contextual_command_completer_for
from xonsh.completers.completer import add_one_completer, remove_completer


def make_absolute(path):
    if not path.is_absolute():
        return Path.home() / &quot;.ssh&quot; / path
    return path


def find_hosts(config_file):
    config_file = make_absolute(config_file)
    if config_file.exists():
        with open(config_file, &quot;r&quot;) as f:
            for line in f:
                line = line.strip()
                if line.lower().startswith(&quot;host &quot;):
                    # Skip wildcards like '*'
                    hosts = line.split()[1:]
                    for host in hosts:
                        if &quot;*&quot; not in host and &quot;?&quot; not in host:
                            yield host
                elif line.lower().startswith(&quot;include &quot;):
                    includes = line.split()[1:]
                    for include in includes:
                        if &quot;*&quot; in include:
                            root, rest = include.split(&quot;*&quot;, 1)
                            root = make_absolute(Path(root))
                            for p in root.glob(f&quot;*{rest}&quot;):
                                yield from find_hosts(p)
                        else:
                            yield from find_hosts(Path(include))


def get_ssh_hosts():
    ssh_config_files = [
        Path.home() / &quot;.ssh&quot; / &quot;config&quot;,
        Path(&quot;/etc/ssh/ssh_config&quot;),
    ]
    for config_file in ssh_config_files:
        yield from find_hosts(config_file)


@contextual_command_completer_for(&quot;ssh&quot;)
def ssh_completer(context):
    hosts = get_ssh_hosts()
    return {host for host in hosts if host.startswith(context.prefix)}


def _load_xontrib_(xsh: XonshSession, **kwargs) -&gt; dict:
    add_one_completer(&quot;ssh-hosts&quot;, ssh_completer, &quot;start&quot;)
    return {}


def _unload_xontrib_(xsh: XonshSession, **kwargs) -&gt; dict:
    remove_completer(&quot;ssh-hosts&quot;)
    return {}
</code></pre>
<p>Most of the file is setup and installation code, nothing interesting happening that you
couldn&rsquo;t just read in the xonsh docs. The interesting parts are the <code>get_ssh_hosts</code> and
<code>find_hosts</code> functions. The former is responsible for looking in directories that
commonly contain SSH config files, when it finds one it passes it to the latter,
<code>find_hosts</code>, and yields the responses.</p>
<p><code>find_hosts</code> goes through the config file line by line looking for config that is either
a) a host directive that can be yielded back as a named host for the user to pick from,
or b) is a nested include directive that calls <code>find_hosts</code> again with a new config
file.</p>
<div class="admonition info">
<p class="admonition-title">Heads up</p>
<p>This file was written to be installed on my computer, and might not work on yours. You
might have to tweak the file paths and change some of the assumptions I&rsquo;ve made.</p>
</div>
<p>You can install and use this xcontrib on your own machine. Copy and paste the contents
into a file, I called mine &ldquo;ssh_host_completer.py&rdquo;. Then save that file to a location
you like. Then update your <code>.xonshrc</code> file to add the location to your path and then
load the xontrib:</p>
<pre><code class="language-python">path.append(&quot;/path/to/location&quot;)
xontrib load ssh_host_completer
</code></pre></div>
    </div>
</main>
        <div class="border-t-2 border-mt-dark-blue py-4 px-4">
            <footer
                class="flex flex-col sm:flex-row items-center justify-between"
            >
                <div class="">
                    <a
                        class="flex flex-row items-center gap-2 font-bold text-2xl"
                        href="/"
                    >
                        <img
                            src="/img/logo.png"
                            alt="The MayorTech limited logo; a pixel art cartoon image of William Mayor."
                            height="56"
                            class="h-14"
                        />
                        MayorTech Limited
                    </a>
                </div>
                <nav class="">
                    <ul class="flex flex-row items-center gap-4">
                        <li class="">
                            <a class="hover:text-mt-red" href="/">Home</a>
                        </li>
                        <li class="">
                            <a class="hover:text-mt-red" href="/projects/">
                                Projects
                            </a>
                        </li>
                        <li class="">
                            <a class="hover:text-mt-red" href="/posts/">Blog</a>
                        </li>
                        <li class="">
                            <a class="hover:text-mt-red" href="/contact/">
                                Contact
                            </a>
                        </li>
                    </ul>
                </nav>
            </footer>
        </div>
        
    <script>
        document.querySelectorAll('pre').forEach(el => {
            el.classList.add("not-prose");
            hljs.highlightElement(el.querySelector('code'));
        });
    </script>

    </body>
</html>