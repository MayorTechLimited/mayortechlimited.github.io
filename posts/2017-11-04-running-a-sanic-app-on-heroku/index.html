<!doctype html>
<html lang="en">
    <head>
        <title>MayorTech Limited</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap"
            rel="stylesheet"
        />
        <link href="/styles.css" rel="stylesheet" />
    </head>

    <body class="bg-orange-50 text-slate-900 p-4">
        <div class="border-b-4 border-brand py-2">
            <header class="max-w-3xl mx-auto">
                <div class="mb-4">
                    <a class="inline-block font-bold text-4xl" href="/">
                        MayorTech Limited
                    </a>
                </div>
                <nav class="">
                    <ul>
                        <li class="block md:inline-block mr-2 my-2 md:my-0">
                            <a
                                class="hover:text-brand decoration-2 text-xl"
                                href="/"
                            >
                                Home
                            </a>
                        </li>
                        <li class="hidden md:inline-block">&middot;</li>
                        <li class="block md:inline-block mx-2 my-2 md:my-0">
                            <a
                                class="hover:text-brand decoration-2 text-xl"
                                href="/projects/"
                            >
                                Projects
                            </a>
                        </li>
                        <li class="hidden md:inline-block">&middot;</li>
                        <!-- <li class="block md:inline-block mx-2 my-2 md:my-0"><a class="hover:text-brand underline underline-offset-4 decoration-2" href="/posts/">Blog</a></li>
                        <li class="hidden md:inline-block">&middot;</li> -->
                        <li class="block md:inline-block ml-2 my-2 md:my-0">
                            <a
                                class="hover:text-brand decoration-2 text-xl"
                                href="/contact/"
                            >
                                Contact Us
                            </a>
                        </li>
                    </ul>
                </nav>
            </header>
        </div>
        <main class="my-8">
    <div class="max-w-2xl mx-auto">
        <div class="">
            <dl class="grid inline-grid grid-cols-2 gap-x-4">
               <dt class="text-right">Author:</dt>
               <dd>William Mayor</dd>
               <dt class="text-right">Written on:</dt>
               <dd>2017-11-04</dd>
            </dl>
        </div>
        <h1>Running a Sanic App on Heroku</h1>
<p>Here's the context; I've built lots of Python-based websites before, mostly using <a href="http://flask.pocoo.org/">Flask</a>. My latest side-project uses <a href="http://sanic.readthedocs.io/en/latest/">Sanic</a> instead. I've hosted lots of websites on <a href="https://heroku.com">Heroku</a> before, I've never hosted a Sanic app, and there didn't seem to be much in the way of documentation.  I managed to get something running, here's how.</p>
<h3>To Gunicorn or Not?</h3>
<p>Normally, when it comes time to put an app in production, I turn to <a href="http://gunicorn.org/">Gunicorn</a>. The local flask development servers that I use until then aren't production-ready. This message, "not production-ready", is really drummed into you by the docs. Not so by the Sanic docs though. In fact, when I first read it, the <a href="http://sanic.readthedocs.io/en/latest/sanic/deploying.html">deployment section</a> of their docs was incredibly sparse. This made me a bit uncertain, do I use the same server in production as I am for dev? Really? That doesn't seem right...</p>
<p>Turns out, it is! Whilst running behind gunicorn is possible, it <a href="https://github.com/channelcat/sanic/issues/61#issuecomment-255982541">doesn't seem like it's encouraged</a>. So no  pip install gunicorn, Sanic comes batteries included.</p>
<p>So what's in the Procfile? There are plenty of ways to get this working, here's mine:</p>
<pre><code>$ cat
Procfile web: python web.py
$ cat web.py
import os

from project import app

if __name__ == '__main__':
    app.run(
        host='0.0.0.0',
        port=int(os.environ.get('PORT', 8000)),
        workers=int(os.environ.get('WEB_CONCURRENCY', 1)),
        debug=bool(os.environ.get('DEBUG', ''))
    )
</code></pre>
<p>Pretty easy right? The only less-than-simple parts here are the environment variables:</p>
<ul>
<li>PORT: This is set by Heroku to let the application know where to bind itself    to. In dev I can easily set this myself, or rely on the default 8000.</li>
<li>WEB_CONCURRENCY: This rather awesome variable is a recommendation from Heroku    on how many worker threads to use, given the dyno that the app is running in.    I'm anticipating modifying this slightly in the future, but for now, thanks    for the recommendation!</li>
<li>DEBUG: This one's pretty obvious, if there's a DEBUG environment variable,    then run Sanic in debug mode.</li>
</ul>
<h2>Using asyncpg?</h2>
<p>Here's a gotcha I came across. I'm using <a href="https://github.com/MagicStack/asyncpg">asyncpg</a> to connect to a PostgreSQL database, I'm using a connection pool, like this:</p>
<pre><code>pool = await asyncpg.create_pool(
    dsn=os.environ['DATABASE_URL'],
    loop=loop # loop comes from sanic
)
</code></pre>
<p>When I first booted my new app I tried to run the database migrations, they failed with a "max connections for role XYZ" error message. Turns out asyncpg will by default create 10 connections when the pool is created. Couple that with the 2 workers that Heroku recommend per Hobby dyno and you've hit the 20 connection limit on the free tier Postgres addon.</p>
<p>To connect to your DB using an external tool you have to turn off the web dynos so that your connections are freed up. That or pay more for your Heroku service :)</p>
<h2>Anything Else?</h2>
<p>That's all I've got so far, I'll update this post when I come across more things worth noting down.</p>
    </div>
</main>
    </body>
</html>